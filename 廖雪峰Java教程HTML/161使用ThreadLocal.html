<div class="uk-flex-item-1" style="padding-left:15px; ">
							<div id="x-content-top">
								<!-- __snippet__.contentTop -->
																<!-- // __snippet__.contentTop -->
							</div>
							<div id="x-content">
								    <h4>&#20351;&#29992;ThreadLocal</h4>
    <div class="x-wiki-info">
    	<span>Reads: 14149</span>
    	<a href="/manage/wiki/wikipage_update?id=1306581251653666" target="_blank" class="x-can-edit uk-text-danger">Edit</a>
</div>

    <hr>

    <div class="x-wiki-content x-main-content">
<p>&#22810;&#32447;&#31243;&#26159;Java&#23454;&#29616;&#22810;&#20219;&#21153;&#30340;&#22522;&#30784;&#65292;<code>Thread</code>&#23545;&#35937;&#20195;&#34920;&#19968;&#20010;&#32447;&#31243;&#65292;&#25105;&#20204;&#21487;&#20197;&#22312;&#20195;&#30721;&#20013;&#35843;&#29992;<code>Thread.currentThread()</code>&#33719;&#21462;&#24403;&#21069;&#32447;&#31243;&#12290;&#20363;&#22914;&#65292;&#25171;&#21360;&#26085;&#24535;&#26102;&#65292;&#21487;&#20197;&#21516;&#26102;&#25171;&#21360;&#20986;&#24403;&#21069;&#32447;&#31243;&#30340;&#21517;&#23383;&#65306;</p>
<pre><code class="language-x-java">// Thread
----
public class Main {
    public static void main(String[] args) throws Exception {
        log("start main...");
        new Thread(() -&gt; {
            log("run task...");
        }).start();
        new Thread(() -&gt; {
            log("print...");
        }).start();
        log("end main.");
    }

    static void log(String s) {
        System.out.println(Thread.currentThread().getName() + ": " + s);
    }
}
</code></pre>
<p>&#23545;&#20110;&#22810;&#20219;&#21153;&#65292;Java&#26631;&#20934;&#24211;&#25552;&#20379;&#30340;&#32447;&#31243;&#27744;&#21487;&#20197;&#26041;&#20415;&#22320;&#25191;&#34892;&#36825;&#20123;&#20219;&#21153;&#65292;&#21516;&#26102;&#22797;&#29992;&#32447;&#31243;&#12290;Web&#24212;&#29992;&#31243;&#24207;&#23601;&#26159;&#20856;&#22411;&#30340;&#22810;&#20219;&#21153;&#24212;&#29992;&#65292;&#27599;&#20010;&#29992;&#25143;&#35831;&#27714;&#39029;&#38754;&#26102;&#65292;&#25105;&#20204;&#37117;&#20250;&#21019;&#24314;&#19968;&#20010;&#20219;&#21153;&#65292;&#31867;&#20284;&#65306;</p>
<pre><code>public void process(User user) {
    checkPermission();
    doWork();
    saveStatus();
    sendResponse();
}
</code></pre>
<p>&#28982;&#21518;&#65292;&#36890;&#36807;&#32447;&#31243;&#27744;&#21435;&#25191;&#34892;&#36825;&#20123;&#20219;&#21153;&#12290;</p>
<p>&#35266;&#23519;<code>process()</code>&#26041;&#27861;&#65292;&#23427;&#20869;&#37096;&#38656;&#35201;&#35843;&#29992;&#33509;&#24178;&#20854;&#20182;&#26041;&#27861;&#65292;&#21516;&#26102;&#65292;&#25105;&#20204;&#36935;&#21040;&#19968;&#20010;&#38382;&#39064;&#65306;&#22914;&#20309;&#22312;&#19968;&#20010;&#32447;&#31243;&#20869;&#20256;&#36882;&#29366;&#24577;&#65311;</p>
<p><code>process()</code>&#26041;&#27861;&#38656;&#35201;&#20256;&#36882;&#30340;&#29366;&#24577;&#23601;&#26159;<code>User</code>&#23454;&#20363;&#12290;&#26377;&#30340;&#31461;&#38795;&#20250;&#24819;&#65292;&#31616;&#21333;&#22320;&#20256;&#20837;<code>User</code>&#23601;&#21487;&#20197;&#20102;&#65306;</p>
<pre><code>public void process(User user) {
    checkPermission(user);
    doWork(user);
    saveStatus(user);
    sendResponse(user);
}
</code></pre>
<p>&#20294;&#26159;&#24448;&#24448;&#19968;&#20010;&#26041;&#27861;&#21448;&#20250;&#35843;&#29992;&#20854;&#20182;&#24456;&#22810;&#26041;&#27861;&#65292;&#36825;&#26679;&#20250;&#23548;&#33268;<code>User</code>&#20256;&#36882;&#21040;&#25152;&#26377;&#22320;&#26041;&#65306;</p>
<pre><code>void doWork(User user) {
    queryStatus(user);
    checkStatus();
    setNewStatus(user);
    log();
}
</code></pre>
<p>&#36825;&#31181;&#22312;&#19968;&#20010;&#32447;&#31243;&#20013;&#65292;&#27178;&#36328;&#33509;&#24178;&#26041;&#27861;&#35843;&#29992;&#65292;&#38656;&#35201;&#20256;&#36882;&#30340;&#23545;&#35937;&#65292;&#25105;&#20204;&#36890;&#24120;&#31216;&#20043;&#20026;&#19978;&#19979;&#25991;&#65288;Context&#65289;&#65292;&#23427;&#26159;&#19968;&#31181;&#29366;&#24577;&#65292;&#21487;&#20197;&#26159;&#29992;&#25143;&#36523;&#20221;&#12289;&#20219;&#21153;&#20449;&#24687;&#31561;&#12290;</p>
<p>&#32473;&#27599;&#20010;&#26041;&#27861;&#22686;&#21152;&#19968;&#20010;context&#21442;&#25968;&#38750;&#24120;&#40635;&#28902;&#65292;&#32780;&#19988;&#26377;&#20123;&#26102;&#20505;&#65292;&#22914;&#26524;&#35843;&#29992;&#38142;&#26377;&#26080;&#27861;&#20462;&#25913;&#28304;&#30721;&#30340;&#31532;&#19977;&#26041;&#24211;&#65292;<code>User</code>&#23545;&#35937;&#23601;&#20256;&#19981;&#36827;&#21435;&#20102;&#12290;</p>
<p>Java&#26631;&#20934;&#24211;&#25552;&#20379;&#20102;&#19968;&#20010;&#29305;&#27530;&#30340;<code>ThreadLocal</code>&#65292;&#23427;&#21487;&#20197;&#22312;&#19968;&#20010;&#32447;&#31243;&#20013;&#20256;&#36882;&#21516;&#19968;&#20010;&#23545;&#35937;&#12290;</p>
<p><code>ThreadLocal</code>&#23454;&#20363;&#36890;&#24120;&#24635;&#26159;&#20197;&#38745;&#24577;&#23383;&#27573;&#21021;&#22987;&#21270;&#22914;&#19979;&#65306;</p>
<pre><code>static ThreadLocal&lt;String&gt; threadLocalUser = new ThreadLocal&lt;&gt;();
</code></pre>
<p>&#23427;&#30340;&#20856;&#22411;&#20351;&#29992;&#26041;&#24335;&#22914;&#19979;&#65306;</p>
<pre><code>void processUser(user) {
    try {
        threadLocalUser.set(user);
        step1();
        step2();
    } finally {
        threadLocalUser.remove();
    }
}
</code></pre>
<p>&#36890;&#36807;&#35774;&#32622;&#19968;&#20010;<code>User</code>&#23454;&#20363;&#20851;&#32852;&#21040;<code>ThreadLocal</code>&#20013;&#65292;&#22312;&#31227;&#38500;&#20043;&#21069;&#65292;&#25152;&#26377;&#26041;&#27861;&#37117;&#21487;&#20197;&#38543;&#26102;&#33719;&#21462;&#21040;&#35813;<code>User</code>&#23454;&#20363;&#65306;</p>
<pre><code>void step1() {
    User u = threadLocalUser.get();
    log();
    printUser();
}

void log() {
    User u = threadLocalUser.get();
    println(u.name);
}

void step2() {
    User u = threadLocalUser.get();
    checkUser(u.id);
}
</code></pre>
<p>&#27880;&#24847;&#21040;&#26222;&#36890;&#30340;&#26041;&#27861;&#35843;&#29992;&#19968;&#23450;&#26159;&#21516;&#19968;&#20010;&#32447;&#31243;&#25191;&#34892;&#30340;&#65292;&#25152;&#20197;&#65292;<code>step1()</code>&#12289;<code>step2()</code>&#20197;&#21450;<code>log()</code>&#26041;&#27861;&#20869;&#65292;<code>threadLocalUser.get()</code>&#33719;&#21462;&#30340;<code>User</code>&#23545;&#35937;&#26159;&#21516;&#19968;&#20010;&#23454;&#20363;&#12290;</p>
<p>&#23454;&#38469;&#19978;&#65292;&#21487;&#20197;&#25226;<code>ThreadLocal</code>&#30475;&#25104;&#19968;&#20010;&#20840;&#23616;<code>Map&lt;Thread, Object&gt;</code>&#65306;&#27599;&#20010;&#32447;&#31243;&#33719;&#21462;<code>ThreadLocal</code>&#21464;&#37327;&#26102;&#65292;&#24635;&#26159;&#20351;&#29992;<code>Thread</code>&#33258;&#36523;&#20316;&#20026;key&#65306;</p>
<pre><code>Object threadLocalValue = threadLocalMap.get(Thread.currentThread());
</code></pre>
<p>&#22240;&#27492;&#65292;<code>ThreadLocal</code>&#30456;&#24403;&#20110;&#32473;&#27599;&#20010;&#32447;&#31243;&#37117;&#24320;&#36767;&#20102;&#19968;&#20010;&#29420;&#31435;&#30340;&#23384;&#20648;&#31354;&#38388;&#65292;&#21508;&#20010;&#32447;&#31243;&#30340;<code>ThreadLocal</code>&#20851;&#32852;&#30340;&#23454;&#20363;&#20114;&#19981;&#24178;&#25200;&#12290;</p>
<p>&#26368;&#21518;&#65292;&#29305;&#21035;&#27880;&#24847;<code>ThreadLocal</code>&#19968;&#23450;&#35201;&#22312;<code>finally</code>&#20013;&#28165;&#38500;&#65306;</p>
<pre><code>try {
    threadLocalUser.set(user);
    ...
} finally {
    threadLocalUser.remove();
}
</code></pre>
<p>&#36825;&#26159;&#22240;&#20026;&#24403;&#21069;&#32447;&#31243;&#25191;&#34892;&#23436;&#30456;&#20851;&#20195;&#30721;&#21518;&#65292;&#24456;&#21487;&#33021;&#20250;&#34987;&#37325;&#26032;&#25918;&#20837;&#32447;&#31243;&#27744;&#20013;&#65292;&#22914;&#26524;<code>ThreadLocal</code>&#27809;&#26377;&#34987;&#28165;&#38500;&#65292;&#35813;&#32447;&#31243;&#25191;&#34892;&#20854;&#20182;&#20195;&#30721;&#26102;&#65292;&#20250;&#25226;&#19978;&#19968;&#27425;&#30340;&#29366;&#24577;&#24102;&#36827;&#21435;&#12290;</p>
<p>&#20026;&#20102;&#20445;&#35777;&#33021;&#37322;&#25918;<code>ThreadLocal</code>&#20851;&#32852;&#30340;&#23454;&#20363;&#65292;&#25105;&#20204;&#21487;&#20197;&#36890;&#36807;<code>AutoCloseable</code>&#25509;&#21475;&#37197;&#21512;<code>try (resource) {...}</code>&#32467;&#26500;&#65292;&#35753;&#32534;&#35793;&#22120;&#33258;&#21160;&#20026;&#25105;&#20204;&#20851;&#38381;&#12290;&#20363;&#22914;&#65292;&#19968;&#20010;&#20445;&#23384;&#20102;&#24403;&#21069;&#29992;&#25143;&#21517;&#30340;<code>ThreadLocal</code>&#21487;&#20197;&#23553;&#35013;&#20026;&#19968;&#20010;<code>UserContext</code>&#23545;&#35937;&#65306;</p>
<pre><code>public class UserContext implements AutoCloseable {

    static final ThreadLocal&lt;String&gt; ctx = new ThreadLocal&lt;&gt;();

    public UserContext(String user) {
        ctx.set(user);
    }

    public static String currentUser() {
        return ctx.get();
    }

    @Override
    public void close() {
        ctx.remove();
    }
}
</code></pre>
<p>&#20351;&#29992;&#30340;&#26102;&#20505;&#65292;&#25105;&#20204;&#20511;&#21161;<code>try (resource) {...}</code>&#32467;&#26500;&#65292;&#21487;&#20197;&#36825;&#20040;&#20889;&#65306;</p>
<pre><code>try (var ctx = new UserContext("Bob")) {
    // &#21487;&#20219;&#24847;&#35843;&#29992;UserContext.currentUser():
    String currentUser = UserContext.currentUser();
} // &#22312;&#27492;&#33258;&#21160;&#35843;&#29992;UserContext.close()&#26041;&#27861;&#37322;&#25918;ThreadLocal&#20851;&#32852;&#23545;&#35937;
</code></pre>
<p>&#36825;&#26679;&#23601;&#22312;<code>UserContext</code>&#20013;&#23436;&#20840;&#23553;&#35013;&#20102;<code>ThreadLocal</code>&#65292;&#22806;&#37096;&#20195;&#30721;&#22312;<code>try (resource) {...}</code>&#20869;&#37096;&#21487;&#20197;&#38543;&#26102;&#35843;&#29992;<code>UserContext.currentUser()</code>&#33719;&#21462;&#24403;&#21069;&#32447;&#31243;&#32465;&#23450;&#30340;&#29992;&#25143;&#21517;&#12290;</p>
<h3>&#32451;&#20064;</h3>
<p><a href="https://gitee.com/liaoxuefeng/learn-java/raw/master/practices/Java%E6%95%99%E7%A8%8B/130.%E5%A4%9A%E7%BA%BF%E7%A8%8B.1255943750561472/200.%E4%BD%BF%E7%94%A8ThreadLocal.1306581251653666/thread-threadlocal.zip">ThreadLocal&#32451;&#20064;</a></p>
<h3>&#23567;&#32467;</h3>
<p><code>ThreadLocal</code>&#34920;&#31034;&#32447;&#31243;&#30340;&#8220;&#23616;&#37096;&#21464;&#37327;&#8221;&#65292;&#23427;&#30830;&#20445;&#27599;&#20010;&#32447;&#31243;&#30340;<code>ThreadLocal</code>&#21464;&#37327;&#37117;&#26159;&#21508;&#33258;&#29420;&#31435;&#30340;&#65307;</p>
<p><code>ThreadLocal</code>&#36866;&#21512;&#22312;&#19968;&#20010;&#32447;&#31243;&#30340;&#22788;&#29702;&#27969;&#31243;&#20013;&#20445;&#25345;&#19978;&#19979;&#25991;&#65288;&#36991;&#20813;&#20102;&#21516;&#19968;&#21442;&#25968;&#22312;&#25152;&#26377;&#26041;&#27861;&#20013;&#20256;&#36882;&#65289;&#65307;</p>
<p>&#20351;&#29992;<code>ThreadLocal</code>&#35201;&#29992;<code>try ... finally</code>&#32467;&#26500;&#65292;&#24182;&#22312;<code>finally</code>&#20013;&#28165;&#38500;&#12290;</p>
</div>

    <hr>

    <div class="x-wiki-prev-next uk-clearfix"></div>

    <div class="x-anchor x-comment-anchor"><a name="comments"></a></div>
							</div>
							<div id="x-content-bottom">
								<!-- __snippet__.contentBottom -->
								<div id="sponsor-a" class="uk-margin-bottom"></div>
								<!-- // __snippet__.contentBottom -->
							</div>
							<div id="x-content-comment">
								    <h3>Comments</h3>

    <ul id="x-comment-list" class="uk-comment-list">
    </ul>

    <h3>Make a comment</h3>

    <div class="x-display-if-not-signin">
        <p><button type="button" class="uk-button" onclick="showSignin()"><i class="uk-icon-signin"></i> Sign in to make a comment</button></p>
    </div>

    <div id="x-comment-area"></div>

							</div>
						</div>
											
